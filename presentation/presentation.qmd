---
title: "Marketing on Facebook: Temporal and Targeted Approaches"
format: revealjs
editor: visual
execute: 
  echo: false
author: Anthony, Brandon, Ghadah, Nicholas, Vinh
---

```{r}
# Import libraries
library(bayesrules)
library(tidyverse)
library(tidybayes)
library(bayesplot)
library(rstanarm)
library(forcats)
library(broom.mixed)
library(dplyr)
library(kableExtra)

# Set seed
set.seed(84735)
```

## Facebook Dataset

2014 Facebook performance metrics of a renowned cosmetics brand containing 500 observations (posts) and 20 variables to describe its engagement

```{r}
data <- read.csv("../data/dataset_Facebook.csv", sep = ";")
data$index <- seq_along(data$Page.total.likes)
fb_data <- data %>% 
  select(index, Post.Month, Post.Weekday, Post.Hour, Total.Interactions, Lifetime.Engaged.Users, Type, Paid)

# fb_data$Total.Interactions[fb_data$Total.Interactions == 0] <- 0.001

head(fb_data)
```

## Distribution of Interactions

-   "link" posts tend to have LOWER counts and MORE consistent interaction counts

-   "video" posts tend to have a much LARGER VARIANCE in their interaction counts

```{r}
# Density plots for each post types
ggplot(fb_data, aes(x = Total.Interactions, group = Type)) + 
  geom_density(aes(color = Type, fill = Type), alpha = 0.3) +
  xlim(c(0, 1000)) +
  labs(title = "Distribution of Interaction Counts by Post Type", x = "Total Interaction Count", y = "Density")
```

## Interactions by Month and Post Type

Temporally, photos and links tend to stay fairly consistent while status posts appear to spike in interactions in April and October.

```{r}
# Turn month into a factor
plot_df <- data
plot_df$Post.Month <- factor(plot_df$Post.Month)

# Find average interactions by month, for each post type
interaction_avg <- aggregate(Total.Interactions ~ Post.Month + Type, data = plot_df, FUN = mean)

# Graph of interactions by month
ggplot(interaction_avg, aes(x = Post.Month, y = Total.Interactions, color = factor(Type), group = Type)) +
  geom_line() +
  labs(title = "Average Post Interactions by Month and Type",
       x = "Post Month", y = "Avg Post Interactions", color = "Post Type") +
  theme_minimal()
```

Note: No video post data exist for months 1-5

## Interactions by Month and Paid Status

Paid posts appear to not provide a major advantage, except for in July and during the "holiday season" (Nov - Dec).

```{r}
# Turn paid status and month into factors
plot_df <- data
plot_df$Paid <- factor(plot_df$Paid)
plot_df$Post.Month <- factor(plot_df$Post.Month)

# Find average interactions by month, for each paid status value
interaction_avg <- aggregate(Total.Interactions ~ Post.Month + Paid, data = plot_df, FUN = mean)

# Graph of interactions by month for paid vs non-paid posts
ggplot(interaction_avg, aes(x = Post.Month, y = Total.Interactions, color = factor(Paid), group = Paid)) +
  geom_line() +
  labs(title = "Average Post Interactions by Month and Paid Status",
       x = "Post Month", y = "Average Post Interactions", color = "Paid Status") +
  scale_color_manual(values = c("0" = "darkorange", "1" = "darkgreen"), 
                     labels = c("Not Paid", "Paid")) +
  theme_minimal()
```

## Research Questions

To explore these patterns, we tackle the following:

1.  Is there a significant difference in interaction rates depending on the month a post is made?

    1a. Is this pattern consistent between paid and non-paid posts?

2.  What types of posts (like images, videos, text) tend to generate higher interaction rates?

## Research Q1 Model

-   We construct a hierarchical model for interaction rates, grouped by month

-   We start with a weakly informative prior based on previously observed rates, but with a large variance

```{r}
# Find average interactions by month
fb_means <- fb_data %>% 
  group_by(Post.Month) %>% 
  summarize(count = n(), avg_interactions = mean(Total.Interactions))
```

## Research Q1 Model (cont.)

```{r}
# Fit model for prior
fb_prior <- stan_glmer(
  Total.Interactions ~ (1 | Post.Month), 
  data = data, family = neg_binomial_2,
  prior_intercept = normal(212.12, 100, autoscale = TRUE),
  # prior = normal(0, 2.5, autoscale = TRUE),
  prior_aux = exponential(1, autoscale = TRUE),
  prior_covariance = decov(reg = 1, conc = 1, shape = 1, scale = 1),
  chains = 4, iter = 5000*2, seed = 84735,
  prior_PD = TRUE)

```

```{r}
prior_summary(fb_prior)
```

## Research Q1 Model (cont.)

```{r}
# Update to get model for posterior
fb_post <- update(fb_prior, prior_PD = FALSE)

summary(fb_post)
```

## Diagnostics

Below are some trace plots from our model, and they appear to be mixing quickly.

```{r}
# Make trace plots
mcmc_trace(fb_post, regex_pars = c("2", "5", "8"))

```

## Global Parameters

-   We must exponentiate these parameter values because a log link is used in our model

-   The average month likely has a mean interaction count between $e^{5.20059}= 181.4$ and $e^{5.451064} = 233.0$

```{r}
tidy(fb_post, effects = "fixed", conf.int = TRUE, conf.level = 0.80) %>% 
  knitr::kable()
```

## 80% Credible Intervals 

-   Below are credible intervals for the first few months

-   For month 1, there is an 80% chance that the mean interaction rate is between $e^{-0.3823} = 0.68$ and $e^{0.0898}= 1.09$ above the average month

```{r}
month_summary <- tidy(fb_post, effects = "ran_vals",
                       conf.int = TRUE, conf.level = 0.80)

month_summary %>%
  mutate(month = level) %>% 
  select(month, conf.low, conf.high) %>%
  slice(1:4) %>% 
  knitr::kable()
```

## Plot by Increasing Mean

```{r}
# Get MCMC chains
fb_chains <- fb_post %>%
  spread_draws(`(Intercept)`, b[,Post.Month]) %>%
  mutate(mu_j = `(Intercept)` + b)

# Get posterior summaries
fb_summary_scaled <- fb_chains %>%
  select(-`(Intercept)`, -b) %>%
  mean_qi(.width = 0.8) %>%
  mutate(Post.Month = fct_reorder(Post.Month, mu_j),
         exp_mu_j = exp(mu_j),
         exp_lower = exp(.lower),
         exp_upper = exp(.upper))

# Plot by INCREASING mu_j
ggplot(fb_summary_scaled,
       aes(x = Post.Month, y = exp_mu_j, ymin = exp_lower, ymax = exp_upper)) +
  geom_pointrange() +
  scale_x_discrete(labels = c(3,6,1,10,11,12,4,8,2,5,9,7)) +
  labs(title = "Mean Facebook Post Interaction Count by Month", y = "Interaction count", x = "Month")
```

## Plot by Order of Month

```{r}
# Plot by MONTH ORDER
fb_summary_scaled$Month <- as.integer(gsub("Post.Month:", "", fb_summary_scaled$Post.Month))
ggplot(fb_summary_scaled,
       aes(x = Month, y = exp_mu_j, ymin = exp_lower, ymax = exp_upper)) +
  geom_pointrange() +
  scale_x_continuous(breaks = 1:12) +
  labs(title = "Mean Facebook Post Interaction Count by Month", y = "Interaction count")
```

## Hypothesis Testing

-   We find the 95% CI for $\mu$ and check if all $\mu_j$ fall within the 95% CI

-   $H_o$ = All $\mu_j$ are equal vs $H_\alpha$ = The null hypothesis is not true

```{r}
#posterior_interval(fb_post, prob = 0.95)

# Table of some mu_j values
fb_summary_scaled %>%
  select(Post.Month, mu_j) %>%
  filter(Post.Month %in% c("Post.Month:1", "Post.Month:3", "Post.Month:5", "Post.Month:7","Post.Month:9")) %>% 
  knitr::kable()
```

## Hypothesis Testing (cont.)

-   The 95% CI for $\mu$ is (5.122, 5.525), but some $\mu_j$ evidently fall above or below this range

-   Therefore we reject the null hypothesis and have evidence that not all $\mu_j$ are equal

## Posterior Predictions

-   Model predicts well, all no-pooled predictions are within the 80% credible intervals

```{r}
set.seed(84735)

# Posterior prediction
predictions_hierarchical <- posterior_predict(fb_post, newdata = fb_means)

# Posterior predictive plots
ppc_intervals(fb_means$avg_interactions, yrep = predictions_hierarchical,
              prob_outer = 0.80) +
  ggplot2::scale_x_continuous(labels = fb_means$Post.Month,
                              breaks = 1:nrow(fb_means)) +
  labs(x = "Month", y = "Interaction counts") +
  geom_hline(yintercept = mean(fb_data$Total.Interactions), linetype = "dashed")
```

## Takeaway

-   The hierarchical model presents a significant difference in post interaction counts by month

-   
